#!/bin/bash

#Â©keithhedger Sat 4 Mar 15:35:56 GMT 2017 kdhedger68713@gmail.com

SERVICEDATA=servicedata
SERVICEFOLDER=servicefiles
LOGFILE=
COMMAND=
RUNTYPE=
PIDFILE=
PIDFOLDER=servicepids
BASENAME=
LOGSFOLDER=servicelogs
RETRYS=3


doService ()
{
	local command
	local pid
	local pidfile
	local logfile
	local tries

	if [ "X$COMMAND" != "X" ];then

		if [ "X$LOGFILE" != "X" ];then
			logfile=${LOGSFOLDER}/${LOGFILE}
		else
			logfile="/dev/null"
		fi

		if [ "X$PIDFILE" = "X" ];then
			pidfile=${PIDFOLDER}/${BASENAME}.pid
		fi


	($COMMAND) &>$logfile &
	pid=$!

	if [ "X$(ps --no-headers $pid)" = "X" ];then
		tries=$RETRYS
		echo "Error runing command $COMMAND ..."
		while [ "X$(ps --no-headers $pid)" = "X" ]
			do
				for((j=1;j<RETRYS;j++))
					do
						($COMMAND) &>$logfile &
						pid=$!
						((tries--))
						echo "$tries tries left ..."
						sleep 1
					done
				echo "Can't run $BASENAME, giving up ..."
				rm $pidfile &>/dev/null||true
				return
			done
	fi
			
	echo $pid > $pidfile

	echo "log=$LOGFILE, rt=$RUNTYPE, command=$COMMAND, pidfile=$pidfile, basename=$BASENAME "
	fi
}

runOneService ()
{
	local com
	local args
	local base logfile command runtype pidfile

#	BASENAME=${1%%.?*}
#	LOGFILE=
#	COMMAND=
#	RUNTYPE=
#	PIDFILE=

	base=${1%%.?*}
	
	while read
		do
			com=$(echo $REPLY|awk '{print $1}')
			args="$(echo -e "${REPLY:${#com}:1000}" | sed -e 's/^[[:space:]]*//;s/[[:space:]]*$//')"
			case "$com" in
				"LOGFILE")
					logfile=$args
					;;
				"RUNTYPE")
					runtype=$args
					;;
				"COMMAND")
					command=$args
					;;
				"PIDFILE")
					pidfile=$args
					;;
			esac
		done < ${SERVICEFOLDER}/${base}.service
echo "log=$logfile, rt=$runtype, command=$command, pidfile=$pidfile, basename=$base "
	
}

runAllServices ()
{
	rm ${PIDFOLDER}/*.pid||true
	while read
		do
	#		echo $REPLY
			BASENAME=${REPLY%%.?*}
			LOGFILE=
			COMMAND=
			RUNTYPE=
			PIDFILE=
		
			while read
				do
					COM=$(echo $REPLY|awk '{print $1}')
					ARGS="$(echo -e "${REPLY:${#COM}:1000}" | sed -e 's/^[[:space:]]*//;s/[[:space:]]*$//')"
					case "$COM" in
						"LOGFILE")
							LOGFILE=$ARGS
							;;
						"RUNTYPE")
							RUNTYPE=$ARGS
							;;
						"COMMAND")
							COMMAND=$ARGS
							;;
						"PIDFILE")
							PIDFILE=$ARGS
							;;
					esac
				done < ${SERVICEFOLDER}/$BASENAME
#	echo "log=$LOGFILE, rt=$RUNTYPE, command=$COMMAND, pidfile=$pidfile, basename=$BASENAME "
			if [ "X$COMMAND" != "X" ];then
			 	if [ "X$RUNTYPE" = "Xonce" ];then
					doService
				fi
			fi
		done < ${SERVICEDATA}/services
}	

killService ()
{
	kill -9 $(cat ${PIDFOLDER}/$1.pid)
	rm  ${PIDFOLDER}/$1.pid
}

main ()
{
	if [ "X$1" = "X" ];then
		echo "need command ..."
		exit 1
	else	
		case $1 in
			"RUNALL")
				runAllServices;
				;;
			"KILL")
				killService $2
				;;
			"RUN")
				runOneService $2
				;;
		esac
	fi
}

main $@



